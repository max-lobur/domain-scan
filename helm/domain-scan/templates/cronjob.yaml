apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ include "domain-scan.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ include "domain-scan.name" . }}
    helm.sh/chart: {{ include "domain-scan.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  schedule: {{ .Values.scan_schedule }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                  - key: app
                    operator: In
                    values:
                    - nginx
                topologyKey: "kubernetes.io/hostname"
          volumes:
            - name: domain-scan-pvc
              persistentVolumeClaim:
                claimName: "{{ .Values.pvc.name }}"
          containers:
            - name: {{ .Chart.Name }}
              image: "{{ .Values.scan_image.repository }}:{{ .Values.scan_image.tag }}"
              imagePullPolicy: {{ .Values.scan_image.pullPolicy }}
              volumeMounts:
                - mountPath: "/scan/reports"
                  name: domain-scan-pvc
              env:
                - name: SCAN_DOMAINS
                  value: "{{ range $i,$e := .Values.scan_domains }}{{if $i}},{{end}}{{$e}}{{end}}"
                - name: SKIP_DOMAINS
                  value: "{{ range $i,$e := .Values.skip_domains }}{{if $i}},{{end}}{{$e}}{{end}}"
              {{- if .Values.amass_opts }}
                - name: AMASS_OPTS
                  value: "{{ .Values.amass_opts }}"
              {{- end }}
              {{- if .Values.aquatone_opts }}
                - name: AQUATONE_OPTS
                  value: "{{ .Values.aquatone_opts }}"
              {{- end }}
              {{- if .Values.rollbar_token }}
                - name: ROLLBAR_TOKEN
                  value: "{{ .Values.rollbar_token }}"
              {{- end }}
              {{- if .Values.healthchecks_key }}  
                - name: HEALTHCHECKS_KEY
                  value: "{{ .Values.healthchecks_key }}"
              {{- end }} 
                - name: REPORTS_HOSTNAME
                  value: "{{ .Values.reports_hostname }}"
              resources:
    {{ toYaml .Values.resources | indent 16 }}
        {{- with .Values.nodeSelector }}
          nodeSelector:
    {{ toYaml . | indent 12 }}
        {{- end }}
        {{- with .Values.tolerations }}
          tolerations:
    {{ toYaml . | indent 12 }}
        {{- end }}
